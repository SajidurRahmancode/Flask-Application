{% extends "base.html" %}

{% block title %}Real-Time LangGraph Weather Prediction{% endblock %}

{% block extra_head %}
<style>
    .agent-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .agent-card.idle {
        background: #f8f9fa;
        border-color: #e9ecef;
    }
    
    .agent-card.running {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-color: #2196F3;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
    }
    
    .agent-card.completed {
        background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        border-color: #4caf50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
    }
    
    .agent-card.error {
        background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
        border-color: #f44336;
        box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);
    }
    
    .progress-bar {
        transition: width 0.5s ease;
    }
    
    .agent-status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-idle { background: #6c757d; color: white; }
    .status-running { background: #007bff; color: white; animation: pulse 1.5s infinite; }
    .status-completed { background: #28a745; color: white; }
    .status-error { background: #dc3545; color: white; }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    .workflow-controls {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .prediction-result {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        max-height: 500px;
        overflow-y: auto;
    }
    
    .connection-status {
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 6px;
        font-weight: bold;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .connection-status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .connection-status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .workflow-progress {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .agent-icon {
        font-size: 1.2em;
        margin-right: 8px;
    }
    
    .real-time-log {
        background: #1e1e1e;
        color: #fff;
        border-radius: 8px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
    }
    
    .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
    }
    
    .log-timestamp {
        color: #888;
        font-size: 0.8em;
    }
    
    .log-agent {
        color: #4fc3f7;
        font-weight: bold;
    }
    
    .log-message {
        color: #e8eaf6;
    }
    
    .log-error {
        color: #ff5722;
    }
    
    .log-success {
        color: #4caf50;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        <i class="fas fa-wifi"></i> WebSocket: Disconnected
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-robot"></i> Real-Time LangGraph Weather Prediction</h2>
                <div>
                    <span class="badge badge-info">Multi-Agent System</span>
                    <span class="badge badge-success">Real-Time Updates</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Control Panel -->
        <div class="col-md-4">
            <div class="workflow-controls">
                <h5><i class="fas fa-cogs"></i> Prediction Controls</h5>
                <form id="predictionForm">
                    <div class="form-group">
                        <label for="location">Location:</label>
                        <input type="text" class="form-control" id="location" name="location" value="Tokyo" required>
                    </div>
                    <div class="form-group">
                        <label for="days">Prediction Days:</label>
                        <select class="form-control" id="days" name="days">
                            <option value="1">1 Day</option>
                            <option value="3" selected>3 Days</option>
                            <option value="7">7 Days</option>
                            <option value="14">14 Days</option>
                        </select>
                    </div>
                    <button type="submit" id="startPrediction" class="btn btn-primary btn-block">
                        <i class="fas fa-play"></i> Start Prediction
                    </button>
                    <button type="button" id="stopWorkflow" class="btn btn-warning btn-block" style="display: none;">
                        <i class="fas fa-stop"></i> Stop Workflow
                    </button>
                </form>
            </div>

            <!-- Workflow Progress -->
            <div class="workflow-progress" id="workflowProgress" style="display: none;">
                <h6><i class="fas fa-tasks"></i> Workflow Progress</h6>
                <div class="progress mb-2">
                    <div id="overallProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="workflowStatus" class="text-muted">Ready to start...</div>
            </div>

            <!-- Real-Time Log -->
            <div class="real-time-log">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Real-Time Log</strong>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="clearLog()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                <div id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[--:--:--]</span> 
                        <span class="log-message">Waiting for connection...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Status Dashboard -->
        <div class="col-md-8">
            <h5><i class="fas fa-users"></i> Multi-Agent System Status</h5>
            <div class="row" id="agentDashboard">
                <!-- Agent cards will be populated by JavaScript -->
            </div>

            <!-- Prediction Result -->
            <div id="predictionResult" class="prediction-result" style="display: none;">
                <h5><i class="fas fa-cloud-sun"></i> Prediction Result</h5>
                <div id="predictionContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Include Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>

<!-- Include jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
// Global WebSocket and state management
let socket = null;
let currentWorkflowId = null;
let agentDefinitions = {};

// Initialize Socket.IO connection
function initializeWebSocket() {
    socket = io();
    
    // Connection events
    socket.on('connect', function() {
        updateConnectionStatus(true);
        addLogEntry('WebSocket connected successfully', 'success');
    });
    
    socket.on('disconnect', function() {
        updateConnectionStatus(false);
        addLogEntry('WebSocket disconnected', 'error');
    });
    
    // Server events
    socket.on('connection_established', function(data) {
        addLogEntry(`Connected to server - Client ID: ${data.client_id}`, 'success');
        agentDefinitions = data.agent_definitions || {};
        initializeAgentDashboard();
    });
    
    socket.on('workflow_status', function(data) {
        updateWorkflowStatus(data);
        addLogEntry(`Workflow ${data.status}: ${data.workflow_id}`, 'info');
    });
    
    socket.on('agent_status', function(data) {
        updateAgentStatus(data);
        addLogEntry(`${data.name}: ${data.message}`, data.status === 'error' ? 'error' : 'info');
    });
    
    socket.on('prediction_result', function(data) {
        displayPredictionResult(data.result);
        addLogEntry('Prediction completed successfully', 'success');
    });
    
    socket.on('workflow_error', function(data) {
        addLogEntry(`Workflow error: ${data.error}`, 'error');
        resetWorkflowState();
    });
    
    socket.on('prediction_started', function(data) {
        currentWorkflowId = data.workflow_id;
        addLogEntry(`Prediction started for ${data.city} (${data.days} days)`, 'info');
        $('#startPrediction').hide();
        $('#stopWorkflow').show();
        $('#workflowProgress').show();
    });
    
    // Listen for prediction completion
    socket.on('prediction_completed', function(data) {
        console.log('Prediction completed:', data);
        addLogEntry(`Prediction completed for ${data.city} (${data.days} days)`, 'success');
        resetWorkflowState();
        
        // Display results
        const resultHtml = `
            <div class="alert alert-success mt-3">
                <h5><i class="fas fa-check-circle"></i> Prediction Completed!</h5>
                <p><strong>City:</strong> ${data.city}</p>
                <p><strong>Days:</strong> ${data.days}</p>
                <p><strong>Workflow ID:</strong> ${data.workflow_id}</p>
                <details>
                    <summary><strong>Detailed Results:</strong></summary>
                    <pre class="mt-2" style="max-height: 300px; overflow-y: auto;">${JSON.stringify(data.result, null, 2)}</pre>
                </details>
            </div>
        `;
        $('#statusDisplay').append(resultHtml);
    });
    
    // Listen for prediction errors
    socket.on('prediction_error', function(data) {
        console.log('Prediction error:', data);
        addLogEntry(`Prediction error: ${data.error}`, 'error');
        resetWorkflowState();
        
        // Display error
        const errorHtml = `
            <div class="alert alert-danger mt-3">
                <h5><i class="fas fa-exclamation-triangle"></i> Prediction Error</h5>
                <p><strong>Workflow ID:</strong> ${data.workflow_id}</p>
                <p><strong>Error:</strong> ${data.error}</p>
            </div>
        `;
        $('#statusDisplay').append(errorHtml);
    });
    
    socket.on('workflow_stopped', function(data) {
        addLogEntry('Workflow stopped by user', 'info');
        resetWorkflowState();
    });
    
    socket.on('error', function(data) {
        addLogEntry(`Error: ${data.message}`, 'error');
    });
}

// Update connection status indicator
function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    if (connected) {
        statusEl.className = 'connection-status connected';
        statusEl.innerHTML = '<i class="fas fa-wifi"></i> WebSocket: Connected';
    } else {
        statusEl.className = 'connection-status disconnected';
        statusEl.innerHTML = '<i class="fas fa-wifi"></i> WebSocket: Disconnected';
    }
}

// Initialize agent dashboard with cards
function initializeAgentDashboard() {
    const dashboard = document.getElementById('agentDashboard');
    dashboard.innerHTML = '';
    
    for (const [agentType, agentInfo] of Object.entries(agentDefinitions)) {
        const agentCard = createAgentCard(agentType, agentInfo);
        dashboard.appendChild(agentCard);
    }
}

// Create agent card element
function createAgentCard(agentType, agentInfo) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4';
    
    col.innerHTML = `
        <div id="agent-${agentType}" class="agent-card idle">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">
                    <i class="${agentInfo.icon} agent-icon"></i>
                    ${agentInfo.name}
                </h6>
                <span class="agent-status-badge status-idle">IDLE</span>
            </div>
            <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted agent-message">Ready to start</small>
            <div class="agent-description mt-2">
                <small>${agentInfo.description}</small>
            </div>
        </div>
    `;
    
    return col;
}

// Update individual agent status
function updateAgentStatus(agentData) {
    const agentType = agentData.agent_id.split('_').slice(1).join('_');
    const agentCard = document.getElementById(`agent-${agentType}`);
    
    if (!agentCard) return;
    
    // Update card styling
    agentCard.className = `agent-card ${agentData.status}`;
    
    // Update status badge
    const badge = agentCard.querySelector('.agent-status-badge');
    badge.className = `agent-status-badge status-${agentData.status}`;
    badge.textContent = agentData.status.toUpperCase();
    
    // Update progress bar
    const progressBar = agentCard.querySelector('.progress-bar');
    progressBar.style.width = `${agentData.progress * 100}%`;
    
    // Update message
    const message = agentCard.querySelector('.agent-message');
    message.textContent = agentData.message;
}

// Update overall workflow status
function updateWorkflowStatus(workflowData) {
    const progressBar = document.getElementById('overallProgress');
    const statusText = document.getElementById('workflowStatus');
    
    if (progressBar) {
        progressBar.style.width = `${workflowData.progress * 100}%`;
    }
    
    if (statusText) {
        statusText.textContent = `Status: ${workflowData.status} - Progress: ${Math.round(workflowData.progress * 100)}%`;
    }
    
    // Update workflow completion
    if (workflowData.status === 'completed') {
        setTimeout(resetWorkflowState, 2000);
    }
}

// Display prediction result
function displayPredictionResult(result) {
    const resultContainer = document.getElementById('predictionResult');
    const resultContent = document.getElementById('predictionContent');
    
    resultContent.innerHTML = `
        <div class="mb-3">
            <h6><i class="fas fa-map-marker-alt"></i> Location: ${result.location}</h6>
            <p class="mb-2"><strong>Method:</strong> ${result.method}</p>
            <p class="mb-2"><strong>Confidence:</strong> ${result.confidence_level}</p>
            <p class="mb-2"><strong>Quality Score:</strong> ${result.quality_score}/1.0</p>
        </div>
        <div class="prediction-text">
            <h6><i class="fas fa-cloud-sun"></i> Prediction:</h6>
            <p>${result.prediction}</p>
        </div>
        ${result.langgraph_analysis ? `
        <div class="mt-3">
            <h6><i class="fas fa-chart-line"></i> Agent Analysis:</h6>
            <ul class="list-unstyled">
                ${Object.entries(result.langgraph_analysis.agent_reports).map(([agent, report]) => 
                    `<li><strong>${agent}:</strong> ${report}</li>`
                ).join('')}
            </ul>
        </div>
        ` : ''}
    `;
    
    resultContainer.style.display = 'block';
    resultContainer.scrollIntoView({ behavior: 'smooth' });
}

// Reset workflow state
function resetWorkflowState() {
    currentWorkflowId = null;
    $('#startPrediction').show();
    $('#stopWorkflow').hide();
    $('#workflowProgress').hide();
    
    // Reset agent cards
    document.querySelectorAll('.agent-card').forEach(card => {
        card.className = 'agent-card idle';
        card.querySelector('.agent-status-badge').className = 'agent-status-badge status-idle';
        card.querySelector('.agent-status-badge').textContent = 'IDLE';
        card.querySelector('.progress-bar').style.width = '0%';
        card.querySelector('.agent-message').textContent = 'Ready to start';
    });
}

// Add log entry
function addLogEntry(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    const timestamp = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    
    let messageClass = 'log-message';
    if (type === 'error') messageClass = 'log-error';
    else if (type === 'success') messageClass = 'log-success';
    
    logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span> 
        <span class="${messageClass}">${message}</span>
    `;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    // Keep only last 50 entries
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.firstChild);
    }
}

// Clear log
function clearLog() {
    const logContainer = document.getElementById('logContainer');
    logContainer.innerHTML = '<div class="log-entry"><span class="log-timestamp">[--:--:--]</span> <span class="log-message">Log cleared</span></div>';
}

// Handle form submission
document.getElementById('predictionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!socket || !socket.connected) {
        addLogEntry('WebSocket not connected. Please refresh the page.', 'error');
        return;
    }
    
    const location = document.getElementById('location').value;
    const days = parseInt(document.getElementById('days').value);
    
    // Send prediction request via WebSocket
    socket.emit('start_prediction', {
        city: location,
        days: days
    });
    
    addLogEntry(`Starting prediction for ${location} (${days} days)`, 'info');
});

// Handle stop workflow
document.getElementById('stopWorkflow').addEventListener('click', function() {
    if (currentWorkflowId && socket) {
        socket.emit('stop_workflow', { workflow_id: currentWorkflowId });
    }
});

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeWebSocket();
    addLogEntry('Real-time dashboard initialized', 'success');
});
</script>
{% endblock %}