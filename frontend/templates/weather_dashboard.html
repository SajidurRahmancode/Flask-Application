{% extends "base.html" %}

{% block title %}LangGraph Multi-Agent Weather - AI Weather Prediction{% endblock %}

{% block extra_css %}
<style>
.weather-header {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #6c5ce7 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.weather-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="1" fill="white" opacity="0.1"/><circle cx="40" cy="80" r="1.5" fill="white" opacity="0.1"/></svg>');
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
}

.langgraph-badge {
    background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
}

.agent-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid #e3f2fd;
}

.agent-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.agent-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}

.agent-status.active {
    background-color: #00b894;
    box-shadow: 0 0 10px rgba(0, 184, 148, 0.5);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(0, 184, 148, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0); }
}

.prediction-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.prediction-card:hover {
    transform: translateY(-5px);
}

.btn-langgraph {
    background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
    border: none;
    padding: 12px 30px;
    font-weight: 600;
    color: white;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
    transition: all 0.3s ease;
}

.btn-langgraph:hover {
    background: linear-gradient(135deg, #5a4fcf 0%, #9085e8 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(108, 92, 231, 0.4);
    color: white;
}

.workflow-step {
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    border-left: 4px solid #6c5ce7;
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f4f8 100%);
}

.workflow-step.active {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
    border-left-color: #00b894;
}

.agent-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.confidence-meter {
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%);
    transition: width 0.5s ease;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 2rem;
}

.method-selection {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f4f8 100%);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="weather-header text-center">
        <h1 class="display-4 fw-bold mb-3">ü§ñ LangGraph Multi-Agent Weather System</h1>
        <p class="lead mb-3">Advanced weather predictions using 5 specialized AI agents working in harmony</p>
        <span class="langgraph-badge">
            <i class="fas fa-network-wired me-2"></i>Powered by LangGraph + StateGraph Orchestration
        </span>
    </div>

    <!-- LangGraph System Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="prediction-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat me-2 text-success"></i>
                        Multi-Agent System Status
                    </h5>
                    <button class="btn btn-outline-info btn-sm" onclick="checkLangGraphStatus()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
                <div id="systemStatus">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Checking system status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Control Panel -->
        <div class="col-lg-4">
            <div class="prediction-card">
                <h5 class="card-title mb-4">
                    <i class="fas fa-sliders-h me-2 text-primary"></i>
                    Prediction Control Center
                </h5>
                
                <form id="predictionForm">
                    <div class="mb-3">
                        <label for="location" class="form-label fw-bold">üìç Location</label>
                        <input type="text" class="form-control" id="location" name="location" value="Tokyo, Japan" required>
                        <div class="form-text">Enter city or region for forecast</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="prediction_days" class="form-label fw-bold">üìÖ Forecast Period</label>
                        <select class="form-select" id="prediction_days" name="prediction_days">
                            <option value="3" selected>3 Days</option>
                            <option value="5">5 Days</option>
                            <option value="7">7 Days</option>
                            <option value="10">10 Days</option>
                            <option value="14">14 Days</option>
                        </select>
                    </div>
                    
                    <!-- Prediction Method Selection -->
                    <div class="method-selection">
                        <label class="form-label fw-bold">ÔøΩ AI Prediction Method</label>
                        
                        <!-- LangGraph Multi-Agent (Featured) -->
                        <div class="form-check mb-2 p-3" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-radius: 8px; border: 2px solid #00b894;">
                            <input class="form-check-input" type="radio" name="predictionMethod" id="langgraph" value="langgraph" checked>
                            <label class="form-check-label fw-bold" for="langgraph" style="color: #00b894;">
                                üåü LangGraph Multi-Agent System
                                <span class="badge bg-success ms-2">FEATURED</span>
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                <strong>5 specialized AI agents:</strong> Data Collector, Pattern Analyzer, Meteorologist, Confidence Assessor, Quality Controller
                            </small>
                        </div>

                        <!-- Other Methods -->
                        <div class="accordion" id="otherMethodsAccordion">
                            <div class="accordion-item border-0">
                                <h6 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#otherMethods">
                                        <small>Other Available Methods</small>
                                    </button>
                                </h6>
                                <div id="otherMethods" class="accordion-collapse collapse" data-bs-parent="#otherMethodsAccordion">
                                    <div class="accordion-body p-2">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="predictionMethod" id="langchainRag" value="langchain_rag">
                                            <label class="form-check-label" for="langchainRag">
                                                üöÄ LangChain + RAG
                                            </label>
                                            <small class="form-text text-muted d-block">Advanced orchestration + conversation memory</small>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="predictionMethod" id="ragLocal" value="rag_local">
                                            <label class="form-check-label" for="ragLocal">
                                                üß† RAG + Local LLM
                                            </label>
                                            <small class="form-text text-muted d-block">Historical patterns + Local AI</small>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="predictionMethod" id="hybrid" value="hybrid">
                                            <label class="form-check-label" for="hybrid">
                                                üîÑ Hybrid Smart Fallback
                                            </label>
                                            <small class="form-text text-muted d-block">Auto-selects best available method</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-langgraph w-100 mb-3">
                        <i class="fas fa-brain me-2"></i>Launch Multi-Agent Prediction
                    </button>
                </form>

                <!-- Agent Status Display -->
                <div class="mt-3 pt-3 border-top">
                    <h6 class="fw-bold text-info mb-3">
                        <i class="fas fa-users me-2"></i>Active Agents
                    </h6>
                    <div id="agentStatusList">
                        <div class="text-center py-3">
                            <i class="fas fa-robot text-muted" style="font-size: 2rem; opacity: 0.3;"></i>
                            <p class="mt-2 mb-0 text-muted small">Start a prediction to see agent activity</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Panel -->
        <div class="col-lg-8">
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner">
                <div class="prediction-card text-center">
                    <div class="mb-3">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <h5>Multi-Agent System Working...</h5>
                    <p class="text-muted mb-3">AI agents are collaborating to generate your weather prediction</p>
                    <div id="workflowProgress">
                        <div class="workflow-step active">
                            <strong>ü§ñ Data Collection Agent:</strong> Gathering weather data...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Prediction Results -->
            <div class="prediction-card">
                <h5 class="card-title mb-4">
                    <i class="fas fa-chart-line me-2 text-success"></i>
                    Weather Forecast Results
                </h5>
                
                <div id="predictionResults">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-network-wired" style="font-size: 4rem; opacity: 0.3; color: #6c5ce7;"></i>
                        <h6 class="mt-3">LangGraph Multi-Agent System Ready</h6>
                        <p>Configure your settings and launch the multi-agent prediction system to get started.</p>
                        <div class="mt-3">
                            <span class="badge bg-light text-dark me-2">
                                <i class="fas fa-database me-1"></i>Data Collector
                            </span>
                            <span class="badge bg-light text-dark me-2">
                                <i class="fas fa-chart-line me-1"></i>Pattern Analyzer
                            </span>
                            <span class="badge bg-light text-dark me-2">
                                <i class="fas fa-cloud me-1"></i>Meteorologist
                            </span>
                            <span class="badge bg-light text-dark me-2">
                                <i class="fas fa-check-circle me-1"></i>Quality Controller
                            </span>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-star me-1"></i>Confidence Assessor
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// CSRF Token
function getCSRFToken() {
    return document.querySelector('meta[name=csrf-token]') ? 
           document.querySelector('meta[name=csrf-token]').getAttribute('content') : '';
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    checkLangGraphStatus();
});

// Check LangGraph system status
async function checkLangGraphStatus() {
    const statusDiv = document.getElementById('systemStatus');
    
    try {
        const response = await fetch('/api/weather/langgraph-status', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.langgraph_available) {
            displaySystemStatus(data);
        } else {
            displaySystemUnavailable();
        }
    } catch (error) {
        console.error('Status check error:', error);
        displaySystemError();
    }
}

// Display system status
function displaySystemStatus(data) {
    const statusDiv = document.getElementById('systemStatus');
    const agentConfigs = data.agent_configs || {};
    
    let agentCards = '';
    const agents = [
        { key: 'data_collector', name: 'Data Collector', icon: 'fas fa-database', color: '#3498db' },
        { key: 'pattern_analyzer', name: 'Pattern Analyzer', icon: 'fas fa-chart-line', color: '#e74c3c' },
        { key: 'meteorologist', name: 'Meteorologist', icon: 'fas fa-cloud', color: '#9b59b6' },
        { key: 'confidence_assessor', name: 'Confidence Assessor', icon: 'fas fa-star', color: '#f39c12' },
        { key: 'quality_controller', name: 'Quality Controller', icon: 'fas fa-check-circle', color: '#27ae60' }
    ];
    
    agents.forEach(agent => {
        const config = agentConfigs[agent.key] || {};
        const threshold = config.confidence_threshold || 0.8;
        const description = config.description || 'AI Agent';
        
        agentCards += `
            <div class="agent-card">
                <div class="d-flex align-items-center mb-2">
                    <span class="agent-status active"></span>
                    <i class="${agent.icon} me-2" style="color: ${agent.color};"></i>
                    <strong>${agent.name}</strong>
                    <span class="badge bg-success ms-auto">Active</span>
                </div>
                <p class="small text-muted mb-2">${description}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Confidence Threshold:</small>
                    <span class="badge bg-light text-dark">${(threshold * 100)}%</span>
                </div>
                <div class="confidence-meter">
                    <div class="confidence-fill" style="width: ${(threshold * 100)}%"></div>
                </div>
            </div>
        `;
    });
    
    statusDiv.innerHTML = `
        <div class="alert alert-success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>LangGraph Multi-Agent System Online</strong>
                </div>
                <span class="badge bg-success">
                    <i class="fas fa-users me-1"></i>${data.agent_count || 5} Agents Active
                </span>
            </div>
        </div>
        
        <div class="agent-grid">
            ${agentCards}
        </div>
        
        <div class="mt-3">
            <h6 class="fw-bold text-info mb-2">
                <i class="fas fa-sitemap me-2"></i>Workflow Status
            </h6>
            <div class="row">
                <div class="col-md-4 text-center">
                    <i class="fas fa-project-diagram text-success" style="font-size: 1.5rem;"></i>
                    <div class="small mt-1">Prediction Graph</div>
                    <span class="badge bg-success">Ready</span>
                </div>
                <div class="col-md-4 text-center">
                    <i class="fas fa-route text-success" style="font-size: 1.5rem;"></i>
                    <div class="small mt-1">Service Selection</div>
                    <span class="badge bg-success">Ready</span>
                </div>
                <div class="col-md-4 text-center">
                    <i class="fas fa-shield-alt text-success" style="font-size: 1.5rem;"></i>
                    <div class="small mt-1">Quality Validation</div>
                    <span class="badge bg-success">Ready</span>
                </div>
            </div>
        </div>
    `;
}

// Display system unavailable
function displaySystemUnavailable() {
    const statusDiv = document.getElementById('systemStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>LangGraph System Unavailable</strong>
            <p class="mb-0 mt-2">The multi-agent system is not currently available. You can still use other prediction methods.</p>
        </div>
    `;
}

// Display system error
function displaySystemError() {
    const statusDiv = document.getElementById('systemStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-times-circle me-2"></i>
            <strong>Status Check Failed</strong>
            <p class="mb-0 mt-2">Unable to check system status. Please try refreshing the page.</p>
        </div>
    `;
}

// Handle prediction form submission
document.getElementById('predictionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    generatePrediction();
});

// Generate Weather Prediction
async function generatePrediction() {
    const form = document.getElementById('predictionForm');
    const formData = new FormData(form);
    const loading = document.getElementById('loadingSpinner');
    const results = document.getElementById('predictionResults');
    const predictionMethod = formData.get('predictionMethod');
    
    // Show loading state
    loading.style.display = 'block';
    results.innerHTML = '';
    
    try {
        // Determine endpoint and method description
        let endpoint, methodDescription;
        
        if (predictionMethod === 'langgraph') {
            endpoint = '/api/weather/predict-langgraph';
            methodDescription = 'LangGraph Multi-Agent System';
            
            // Show agent workflow progress
            showAgentWorkflow();
        } else {
            // Map other methods to their endpoints
            switch(predictionMethod) {
                case 'langchain_rag':
                    endpoint = '/api/weather/predict-langchain-rag';
                    methodDescription = 'LangChain + RAG';
                    break;
                case 'rag_local':
                    endpoint = '/api/weather/predict-rag-local';
                    methodDescription = 'RAG + Local LLM';
                    break;
                case 'hybrid':
                default:
                    endpoint = '/api/weather/predict-hybrid';
                    methodDescription = 'Hybrid Smart Fallback';
            }
        }
        
        console.log(`üöÄ Using ${methodDescription} prediction`);
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                location: formData.get('location'),
                timeframe: parseInt(formData.get('prediction_days'))
            })
        });
        
        const data = await response.json();
        
        // Hide loading
        loading.style.display = 'none';
        
        if (data.success) {
            displayPredictionResults(data, predictionMethod);
        } else {
            displayError(data.error || 'Prediction failed', data.error_type);
        }
    } catch (error) {
        console.error('Prediction error:', error);
        loading.style.display = 'none';
        displayError('Network error occurred');
    }
}

// Show agent workflow progress for LangGraph
function showAgentWorkflow() {
    const workflowDiv = document.getElementById('workflowProgress');
    const steps = [
        'ü§ñ Data Collection Agent: Gathering weather data...',
        'üìä Pattern Analysis Agent: Analyzing historical patterns...',
        'üå§Ô∏è Meteorological Agent: Applying atmospheric science...',
        '‚≠ê Confidence Assessment Agent: Evaluating reliability...',
        '‚úÖ Quality Control Agent: Validating predictions...'
    ];
    
    let html = '';
    steps.forEach((step, index) => {
        html += `
            <div class="workflow-step ${index === 0 ? 'active' : ''}" id="step-${index}">
                ${step}
            </div>
        `;
    });
    
    workflowDiv.innerHTML = html;
    
    // Simulate workflow progress
    let currentStep = 0;
    const progressInterval = setInterval(() => {
        if (currentStep < steps.length - 1) {
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            currentStep++;
            document.getElementById(`step-${currentStep}`).classList.add('active');
        } else {
            clearInterval(progressInterval);
        }
    }, 1500);
}

// Display prediction results
function displayPredictionResults(data, method) {
    const results = document.getElementById('predictionResults');
    
    // Determine method badge and description
    let methodBadge, methodDescription, badgeClass;
    
    if (method === 'langgraph') {
        methodBadge = '<span class="badge langgraph-badge"><i class="fas fa-network-wired me-1"></i>LangGraph Multi-Agent</span>';
        methodDescription = 'Generated by 5 specialized AI agents working in harmony';
        
        // Show agent insights if available
        let agentInsights = '';
        if (data.agent_insights && Array.isArray(data.agent_insights)) {
            agentInsights = `
                <div class="mt-4">
                    <h6 class="fw-bold text-info mb-3">
                        <i class="fas fa-users me-2"></i>Agent Insights
                    </h6>
                    <div class="agent-grid">
            `;
            
            data.agent_insights.forEach((insight, index) => {
                const agentNames = ['Data Collector', 'Pattern Analyzer', 'Meteorologist', 'Confidence Assessor', 'Quality Controller'];
                const agentIcons = ['fas fa-database', 'fas fa-chart-line', 'fas fa-cloud', 'fas fa-star', 'fas fa-check-circle'];
                const agentColors = ['#3498db', '#e74c3c', '#9b59b6', '#f39c12', '#27ae60'];
                
                agentInsights += `
                    <div class="agent-card">
                        <div class="d-flex align-items-center mb-2">
                            <i class="${agentIcons[index] || 'fas fa-robot'} me-2" style="color: ${agentColors[index] || '#6c5ce7'};"></i>
                            <strong>${agentNames[index] || `Agent ${index + 1}`}</strong>
                        </div>
                        <p class="small mb-0">${typeof insight === 'string' ? insight : JSON.stringify(insight)}</p>
                    </div>
                `;
            });
            
            agentInsights += `
                    </div>
                </div>
            `;
        }
        
        // Show confidence scores if available
        let confidenceDisplay = '';
        if (data.confidence_scores) {
            const overallConfidence = Object.values(data.confidence_scores).reduce((a, b) => a + b, 0) / Object.keys(data.confidence_scores).length;
            confidenceDisplay = `
                <div class="mt-3">
                    <h6 class="fw-bold text-success mb-2">
                        <i class="fas fa-chart-bar me-2"></i>Confidence Assessment
                    </h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Overall Confidence:</span>
                        <span class="fw-bold">${(overallConfidence * 100).toFixed(1)}%</span>
                    </div>
                    <div class="confidence-meter">
                        <div class="confidence-fill" style="width: ${(overallConfidence * 100)}%"></div>
                    </div>
                </div>
            `;
        }
        
        results.innerHTML = `
            <div class="alert alert-success">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Multi-Agent Prediction Generated Successfully</strong>
                    </div>
                    <div class="text-end">
                        ${methodBadge}
                        <br>
                        <span class="badge bg-secondary mt-1"><i class="fas fa-map-marker-alt me-1"></i>${data.location}</span>
                        <span class="badge bg-info mt-1"><i class="fas fa-calendar me-1"></i>${data.timeframe || data.prediction_days} days</span>
                    </div>
                </div>
                <small class="text-muted d-block mt-2">${methodDescription}</small>
            </div>
            
            <div class="prediction-content">
                <div class="card">
                    <div class="card-body">
                        <pre class="weather-forecast mb-0">${data.prediction}</pre>
                    </div>
                </div>
            </div>
            
            ${confidenceDisplay}
            ${agentInsights}
            
            <div class="mt-4 alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Multi-Agent Advantage:</strong> This prediction was generated using 5 specialized AI agents that collaborated to analyze data patterns, apply meteorological science, and ensure quality control for maximum accuracy.
            </div>
            
            <div class="mt-3">
                <div class="row text-center">
                    <div class="col-md-4">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Generated: ${new Date(data.timestamp || Date.now()).toLocaleString()}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">
                            <i class="fas fa-network-wired me-1"></i>
                            Agents: 5 Specialists
                        </small>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Quality: Validated
                        </small>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Handle other prediction methods
        switch(method) {
            case 'langchain_rag':
                methodBadge = '<span class="badge bg-purple"><i class="fas fa-star me-1"></i>LangChain + RAG</span>';
                methodDescription = 'Advanced orchestration with conversation memory + RAG';
                break;
            case 'rag_local':
                methodBadge = '<span class="badge bg-success"><i class="fas fa-brain me-1"></i>RAG + Local LLM</span>';
                methodDescription = 'Historical patterns + local AI processing';
                break;
            case 'hybrid':
            default:
                methodBadge = '<span class="badge bg-info"><i class="fas fa-magic me-1"></i>Hybrid Smart</span>';
                methodDescription = 'Intelligent method selection with fallback';
        }
        
        results.innerHTML = `
            <div class="alert alert-success">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Prediction Generated Successfully</strong>
                    </div>
                    <div class="text-end">
                        ${methodBadge}
                        <br>
                        <span class="badge bg-secondary mt-1"><i class="fas fa-map-marker-alt me-1"></i>${data.location}</span>
                        <span class="badge bg-info mt-1"><i class="fas fa-calendar me-1"></i>${data.timeframe || data.prediction_days} days</span>
                    </div>
                </div>
                <small class="text-muted d-block mt-2">${methodDescription}</small>
            </div>
            
            <div class="prediction-content">
                <div class="card">
                    <div class="card-body">
                        <pre class="weather-forecast mb-0">${data.prediction}</pre>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Update agent status list
    updateAgentStatusList();
    
    // Scroll to results
    results.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Update agent status list
function updateAgentStatusList() {
    const agentStatusDiv = document.getElementById('agentStatusList');
    
    agentStatusDiv.innerHTML = `
        <div class="small">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-database me-1 text-primary"></i>Data Collector</span>
                <span class="badge bg-success">Complete</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-chart-line me-1 text-warning"></i>Pattern Analyzer</span>
                <span class="badge bg-success">Complete</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-cloud me-1 text-info"></i>Meteorologist</span>
                <span class="badge bg-success">Complete</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-star me-1 text-warning"></i>Confidence Assessor</span>
                <span class="badge bg-success">Complete</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-check-circle me-1 text-success"></i>Quality Controller</span>
                <span class="badge bg-success">Complete</span>
            </div>
        </div>
    `;
}

// Display error message
function displayError(errorMessage, errorType = null) {
    const results = document.getElementById('predictionResults');
    
    results.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Prediction Error:</strong> ${errorMessage}
        </div>
        <div class="text-center py-3">
            <button class="btn btn-outline-primary" onclick="generatePrediction()">
                <i class="fas fa-redo me-2"></i>Try Again
            </button>
        </div>
    `;
}
</script>
{% endblock %}