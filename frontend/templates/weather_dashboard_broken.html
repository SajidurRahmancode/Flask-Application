{% extends "base.html" %}

{% block title %}Weather Prediction - Japan AI Weather{% endblock %}

{% block extra_css %}
<style>
.weather-header {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #6c5ce7 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.weather-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="70" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
    animation: float 20s infinite linear;
}

@keyframes float {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.prediction-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.prediction-card:hover {
    transform: translateY(-5px);
}

.weather-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.data-summary-card {
    background: linear-gradient(135deg, #a8e6cf 0%, #81c784 100%);
    color: white;
    border-radius: 15px;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 2rem;
}

.prediction-result {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1rem;
    white-space: pre-wrap;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
}

.form-floating {
    margin-bottom: 1rem;
}

.btn-predict {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-predict:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(116, 185, 255, 0.4);
}

.recent-data-chart {
    height: 300px;
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="weather-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="display-4 mb-3">
                <i class="fas fa-cloud-sun me-3"></i>
                Japan AI Weather Prediction
            </h1>
            <p class="lead mb-0">
                Advanced weather forecasting powered by LangChain, Gemini AI, and historical electricity load data from Japan
            </p>
        </div>
        <div class="col-md-4 text-end">
            <div class="weather-icon">
                üå§Ô∏è
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Prediction Form -->
    <div class="col-lg-4">
        <div class="prediction-card p-4 mb-4">
            <h5 class="card-title mb-4">
                <i class="fas fa-search-location me-2 text-primary"></i>
                Weather Prediction
            </h5>
            
            <form id="predictionForm">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="location" name="location" value="Tokyo" placeholder="Location">
                    <label for="location">Location in Japan</label>
                </div>
                
                <div class="form-floating mb-3">
                    <select class="form-select" id="predictionDays" name="prediction_days">
                        <option value="1">1 Day</option>
                        <option value="3" selected>3 Days</option>
                        <option value="5">5 Days</option>
                        <option value="7">7 Days</option>
                        <option value="10">10 Days</option>
                    </select>
                    <label for="predictionDays">Prediction Period</label>
                </div>

                <!-- RAG Enhancement Options -->
                <div class="mb-3">
                    <label class="form-label fw-bold text-primary">
                        <i class="fas fa-robot me-2"></i>AI Enhancement Method
                    </label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="predictionMethod" id="standardAI" value="standard" checked>
                        <label class="form-check-label" for="standardAI">
                            Standard AI Prediction
                        </label>
                        <small class="form-text text-muted d-block">Basic LangChain + Gemini AI</small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="predictionMethod" id="ragEnhanced" value="rag">
                        <label class="form-check-label" for="ragEnhanced">
                            üß† RAG-Enhanced Prediction
                        </label>
                        <small class="form-text text-muted d-block">Historical pattern matching + AI</small>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-predict btn-primary w-100">
                    <i class="fas fa-brain me-2"></i>Generate AI Prediction
                </button>

                <!-- Pattern Search Section -->
                <div class="mt-3 pt-3 border-top">
                    <label class="form-label fw-bold text-info">
                        <i class="fas fa-search me-2"></i>Search Weather Patterns
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="patternQuery" placeholder="e.g., hot summer days, rainy season">
                        <button type="button" class="btn btn-info" onclick="searchWeatherPatterns()">
                            Search
                        </button>
                    </div>
                    <small class="text-muted">Find similar historical weather patterns</small>
                </div>
                
                <button type="button" class="btn btn-outline-info w-100 mt-2" onclick="testAPIConnection()">
                    <i class="fas fa-wifi me-2"></i>Test Basic API Connection
                </button>
                
                <button type="button" class="btn btn-outline-warning w-100 mt-2" onclick="testPredictionAPI()">
                    <i class="fas fa-bug me-2"></i>Test Prediction API
                </button>
            </form>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Generating prediction...</span>
                </div>
                <p class="mt-2">AI is analyzing weather patterns...</p>
            </div>
        </div>
        
        <!-- Data Summary -->
        <div class="data-summary-card p-4">
            <h6 class="mb-3">
                <i class="fas fa-database me-2"></i>
                Dataset Information
            </h6>
            <div id="dataSummary">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Loading data summary...</span>
            </div>
        </div>
    </div>
    
    <!-- Prediction Results -->
    <div class="col-lg-8">
        <div class="prediction-card p-4">
            <h5 class="card-title mb-4">
                <i class="fas fa-chart-line me-2 text-success"></i>
                AI Weather Forecast
            </h5>
            
            <div id="predictionResults">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-cloud-sun" style="font-size: 4rem; opacity: 0.3;"></i>
                    <h6 class="mt-3">Ready for Weather Prediction</h6>
                    <p>Select your location and prediction period, then click "Generate AI Prediction" to get started.</p>
                </div>
            </div>

            <!-- Pattern Search Results -->
            <div id="patternSearchResults" style="display: none;">
                <div class="mt-4">
                    <h5 class="text-info mb-3">
                        <i class="fas fa-search me-2"></i>
                        Pattern Search Results
                    </h5>
                    <div id="patternResultsContent"></div>
                </div>
            </div>
        </div>
        
        <!-- Recent Weather Data Visualization -->
        <div class="prediction-card p-4 mt-4">
            <h5 class="card-title mb-4">
                <i class="fas fa-chart-area me-2 text-info"></i>
                Recent Weather Trends (Last 7 Days)
            </h5>
            
            <div class="row">
                <div class="col-md-6">
                    <canvas id="temperatureChart" class="recent-data-chart"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="humidityChart" class="recent-data-chart"></canvas>
                </div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-outline-info btn-sm" onclick="loadRecentData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{{ url_for('auth.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
            <div>
                <small class="text-muted">
                    Powered by <strong>LangChain</strong>, <strong>Gemini AI</strong>, and Japan electricity data
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let temperatureChart = null;
let humidityChart = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadDataSummary();
    loadRecentData();
    testAPIConnection();  // Add API connection test
});

// Get CSRF token from template
function getCSRFToken() {
    return '{{ csrf_token() }}';
}

// Test API connection
async function testAPIConnection() {
    console.log('üß™ Testing API connection...');
    try {
        const response = await fetch('/api/weather/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                test: 'API connection test',
                timestamp: new Date().toISOString()
            })
        });
        
        const data = await response.json();
        console.log('‚úÖ API test response:', data);
        
        if (response.ok) {
            console.log('‚úÖ API connection working');
        } else {
            console.error('‚ùå API test failed:', data);
        }
    } catch (error) {
        console.error('‚ùå API connection error:', error);
    }
}

// Handle prediction form submission
document.getElementById('predictionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    generatePrediction();
});

async function generatePrediction() {
    const form = document.getElementById('predictionForm');
    const formData = new FormData(form);
    const loading = document.getElementById('loadingSpinner');
    const results = document.getElementById('predictionResults');
    const predictionMethod = formData.get('predictionMethod');
    
    // Show loading state
    loading.style.display = 'block';
    results.innerHTML = '';
    
    // Clear pattern search results when generating new prediction
    document.getElementById('patternSearchResults').style.display = 'none';
    
    try {
        // Determine endpoint based on prediction method
        const endpoint = predictionMethod === 'rag' ? '/api/weather/predict-rag' : '/api/weather/predict';
        
        console.log(`üöÄ Using ${predictionMethod === 'rag' ? 'RAG-enhanced' : 'standard'} prediction`);
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                location: formData.get('location'),
                timeframe: parseInt(formData.get('prediction_days'))
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayPredictionResults(data);
        } else {
            displayError(data.error || 'Prediction failed');
        }
    } catch (error) {
        console.error('Prediction error:', error);
        displayError('Network error occurred. Please try again.');
    } finally {
        loading.style.display = 'none';
    }
}

function displayPredictionResults(data) {
    const results = document.getElementById('predictionResults');
    const timestamp = new Date(data.timestamp || data.generated_at).toLocaleString();
    const method = data.method === 'rag_enhanced' ? 'üß† RAG-Enhanced' : 'ü§ñ Standard AI';
    
    results.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 text-success">
                <i class="fas fa-check-circle me-1"></i>
                ${method} Prediction for ${data.location} (${data.timeframe || data.prediction_days} days)
            </h6>
            <small class="text-muted">Generated: ${timestamp}</small>
        </div>
        <div class="prediction-result">
${data.prediction}
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Method: ${method} ${data.method === 'rag_enhanced' ? '(Historical Pattern Matching)' : '(Direct AI Analysis)'}
            </small>
        </div>
    `;
}

function displayError(message) {
    const results = document.getElementById('predictionResults');
    results.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Prediction Error:</strong> ${message}
        </div>
    `;
}

async function loadDataSummary() {
    const summaryDiv = document.getElementById('dataSummary');
    
    try {
        const response = await fetch('/api/weather/data-summary', {
            headers: {}
        });
        
        const data = await response.json();
        
        if (response.ok) {
            summaryDiv.innerHTML = `
                <div class="mb-2">
                    <small><strong>Records:</strong> ${data.total_records.toLocaleString()}</small>
                </div>
                <div class="mb-2">
                    <small><strong>Period:</strong> ${new Date(data.date_range.start).toLocaleDateString()} - ${new Date(data.date_range.end).toLocaleDateString()}</small>
                </div>
                <div class="mb-2">
                    <small><strong>Locations:</strong> ${data.locations.join(', ')}</small>
                </div>
                <div>
                    <small><strong>Completeness:</strong> ${data.data_quality.completeness}</small>
                </div>
            `;
        } else {
            summaryDiv.innerHTML = `<small class="text-warning">Unable to load data summary</small>`;
        }
    } catch (error) {
        summaryDiv.innerHTML = `<small class="text-warning">Error loading summary</small>`;
    }
}

async function loadRecentData() {
    try {
        const response = await fetch('/api/weather/recent-data?days=7', {
            headers: {}
        });
        
        const data = await response.json();
        
        if (response.ok) {
            updateCharts(data.data, data.dates);
        }
    } catch (error) {
        console.error('Error loading recent data:', error);
    }
}

function updateCharts(data, dates) {
    // Destroy existing charts
    if (temperatureChart) temperatureChart.destroy();
    if (humidityChart) humidityChart.destroy();
    
    // Temperature Chart
    const tempCtx = document.getElementById('temperatureChart').getContext('2d');
    temperatureChart = new Chart(tempCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Temperature (¬∞C)',
                data: data.map(d => d['Actual_Temperature(¬∞C)']),
                borderColor: '#ff7675',
                backgroundColor: 'rgba(255, 118, 117, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Temperature Trend'
                }
            }
        }
    });
    
    // Humidity Chart
    const humidityCtx = document.getElementById('humidityChart').getContext('2d');
    humidityChart = new Chart(humidityCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Humidity (%)',
                data: data.map(d => d['Actual_Humidity(%)']),
                borderColor: '#74b9ff',
                backgroundColor: 'rgba(116, 185, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Humidity Trend'
                }
            }
        }
    });
}

// Test prediction API specifically
async function testPredictionAPI() {
    console.log('üîç Testing prediction API...');
    const results = document.getElementById('predictionResults');
    
    results.innerHTML = '<div class="alert alert-info">üß™ Testing API connection...</div>';
    
    try {
        // Test the prediction endpoint with simple data
        const response = await fetch('/api/weather/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                location: 'Tokyo',
                prediction_days: 1
            })
        });
        
        console.log('üì° Prediction API response status:', response.status);
        console.log('üì° Prediction API response headers:', response.headers);
        
        const text = await response.text();
        console.log('üì° Raw response text:', text);
        
        try {
            const data = JSON.parse(text);
            console.log('‚úÖ Prediction API JSON response:', data);
            
            results.innerHTML = `
                <div class="alert alert-success">
                    <h6>‚úÖ API Connection Test Results</h6>
                    <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                    <p><strong>Response:</strong> Valid JSON received</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        } catch (parseError) {
            console.error('‚ùå JSON parse error:', parseError);
            results.innerHTML = `
                <div class="alert alert-danger">
                    <h6>‚ùå API Test Failed - Invalid JSON</h6>
                    <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                    <p><strong>Raw Response:</strong></p>
                    <pre>${text}</pre>
                    <p><strong>Error:</strong> ${parseError.message}</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('‚ùå Network error:', error);
        results.innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Network Error</h6>
                <p><strong>Error:</strong> ${error.message}</p>
            </div>
        `;
    }
}

function getAuthToken() {
    // Using session-based authentication
    return 'session-based-auth';
}

// ================ RAG PATTERN SEARCH FUNCTIONS ================

async function searchWeatherPatterns() {
    const query = document.getElementById('patternQuery').value.trim();
    
    if (!query) {
        alert('Please enter a search query for weather patterns');
        return;
    }
    
    console.log(`üîç Searching weather patterns for: ${query}`);
    
    try {
        const response = await fetch('/api/weather/rag-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                query: query,
                limit: 8  // Get top 8 results
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayPatternSearchResults(data, query);
        } else {
            displayPatternSearchError(data.error);
        }
    } catch (error) {
        console.error('Pattern search error:', error);
        displayPatternSearchError('Network error occurred during pattern search');
    }
}

function displayPatternSearchResults(data, query) {
    const resultsDiv = document.getElementById('patternSearchResults');
    const contentDiv = document.getElementById('patternResultsContent');
    
    if (!data.results || data.results.length === 0) {
        contentDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-search me-2"></i>
                <strong>No patterns found</strong> for query: "${query}"
            </div>
        `;
        resultsDiv.style.display = 'block';
        return;
    }
    
    let html = `
        <div class="alert alert-info">
            <i class="fas fa-search me-2"></i>
            Found <strong>${data.results.length}</strong> similar weather patterns for: "<em>${query}</em>"
        </div>
    `;
    
    data.results.forEach((result, index) => {
        const metadata = result.metadata || {};
        const temperature = metadata.avg_temp ? `${metadata.avg_temp.toFixed(1)}¬∞C` : 'N/A';
        const humidity = metadata.avg_humidity ? `${metadata.avg_humidity.toFixed(1)}%` : 'N/A';
        const season = metadata.season || 'Unknown';
        const date = metadata.date || 'Unknown';
        const docType = result.doc_type || 'weather';
        const relevanceScore = result.relevance_score ? (result.relevance_score * 100).toFixed(1) + '%' : 'N/A';
        
        html += `
            <div class="card mb-3 pattern-result-card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar me-2"></i>Pattern ${index + 1}: ${date}
                        <span class="badge bg-primary ms-2">${season}</span>
                        <span class="badge bg-secondary ms-1">${docType}</span>
                        <span class="badge bg-success ms-1">Relevance: ${relevanceScore}</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="card-text">${result.content.substring(0, 300)}${result.content.length > 300 ? '...' : ''}</p>
                        </div>
                        <div class="col-md-4">
                            <div class="weather-stats">
                                <div class="stat-item">
                                    <i class="fas fa-thermometer-half text-danger"></i>
                                    <span>Temperature: ${temperature}</span>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-tint text-primary"></i>
                                    <span>Humidity: ${humidity}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
        const windSpeed = result.wind_speed ? `${result.wind_speed.toFixed(1)} m/s` : 'N/A';
        const season = result.season || 'Unknown';
        const date = result.date ? new Date(result.date).toLocaleDateString() : 'N/A';
        
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-cloud me-2 text-info"></i>
                        Pattern ${index + 1} ${date !== 'N/A' ? `(${date})` : ''}
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="card-text mb-1">
                                <strong>Temperature:</strong> ${temperature}
                            </p>
                            <p class="card-text mb-1">
                                <strong>Humidity:</strong> ${humidity}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="card-text mb-1">
                                <strong>Wind Speed:</strong> ${windSpeed}
                            </p>
                            <p class="card-text mb-1">
                                <strong>Season:</strong> ${season}
                            </p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">${result.content}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

function displayPatternSearchError(error) {
    const resultsDiv = document.getElementById('patternSearchResults');
    const contentDiv = document.getElementById('patternResultsContent');
    
    contentDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Pattern Search Error:</strong> ${error}
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

// Allow Enter key for pattern search
document.getElementById('patternQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchWeatherPatterns();
    }
});
</script>
{% endblock %}